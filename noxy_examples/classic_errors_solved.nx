// ============================================
// 4 ERROS CLÃSSICOS RESOLVIDOS COM RESULT
// ============================================
// Este arquivo demonstra como o padrÃ£o Result resolve
// os 4 erros mais comuns que quebram programas

print("=== 4 ERROS CLÃSSICOS RESOLVIDOS ===")
print("")

// Struct Result (versÃ£o simplificada)
struct Result
    is_success: bool,
    value: int,
    error_code: int
end

// CÃ³digos de erro
let ERROR_DIVISION_BY_ZERO: int = 1
let ERROR_ARRAY_OUT_OF_BOUNDS: int = 2
let ERROR_NULL_DEREFERENCE: int = 3
let ERROR_PARSE_FAILURE: int = 4

// Construtores
func Ok(value: int) -> Result
    return Result(true, value, 0)
end

func Err(error_code: int) -> Result
    return Result(false, 0, error_code)
end

// UtilitÃ¡rios
func is_ok(result: Result) -> bool
    return result.is_success
end

func is_err(result: Result) -> bool
    return !result.is_success
end

func unwrap_or(result: Result, default_value: int) -> int
    if is_ok(result) then
        return result.value
    else
        return default_value
    end
end

func error_name(code: int) -> string
    if code == ERROR_DIVISION_BY_ZERO then
        return "DIVISION_BY_ZERO"
    end
    if code == ERROR_ARRAY_OUT_OF_BOUNDS then
        return "ARRAY_OUT_OF_BOUNDS"
    end
    if code == ERROR_NULL_DEREFERENCE then
        return "NULL_DEREFERENCE"
    end
    if code == ERROR_PARSE_FAILURE then
        return "PARSE_FAILURE"
    end
    return "UNKNOWN_ERROR"
end

func print_result(name: string, result: Result)
    if is_ok(result) then
        print("âœ… " + name + ": " + to_str(result.value))
    else
        print("âŒ " + name + ": " + error_name(result.error_code))
    end
end

// ============================================
// ERRO #1: DIVISÃƒO POR ZERO
// ============================================

func safe_divide(a: int, b: int) -> Result
    if b == 0 then
        return Err(ERROR_DIVISION_BY_ZERO)
    end
    return Ok(a / b)
end

print("ðŸ”¥ ERRO #1: DIVISÃƒO POR ZERO")
print("Problema: DivisÃ£o por zero quebra o programa")
print("SoluÃ§Ã£o: VerificaÃ§Ã£o explÃ­cita com Result")
print("")

let div_ok: Result = safe_divide(20, 4)
let div_fail: Result = safe_divide(10, 0)

print_result("20 Ã· 4", div_ok)
print_result("10 Ã· 0", div_fail)

if is_ok(div_ok) then
    print("â†’ Posso usar o resultado: " + to_str(div_ok.value))
end

if is_err(div_fail) then
    print("â†’ Erro detectado, usando valor padrÃ£o: " + to_str(unwrap_or(div_fail, -1)))
end

print("")

// ============================================
// ERRO #2: ACESSO FORA DOS LIMITES DO ARRAY
// ============================================

func safe_array_get(array: int[], size: int, index: int) -> Result
    if index < 0 | index >= size then
        return Err(ERROR_ARRAY_OUT_OF_BOUNDS)
    end
    return Ok(array[index])
end

print("ðŸ”¥ ERRO #2: ARRAY OUT OF BOUNDS")
print("Problema: Acesso invÃ¡lido causa buffer overflow")
print("SoluÃ§Ã£o: VerificaÃ§Ã£o de limites com Result")
print("")

let numbers: int[5] = [10, 20, 30, 40, 50]

let access_ok: Result = safe_array_get(numbers, 5, 2)
let access_fail: Result = safe_array_get(numbers, 5, 10)
let access_negative: Result = safe_array_get(numbers, 5, -1)

print_result("array[2]", access_ok)
print_result("array[10]", access_fail)
print_result("array[-1]", access_negative)

if is_ok(access_ok) then
    print("â†’ Valor seguro: " + to_str(access_ok.value))
end

print("")

// ============================================
// ERRO #3: NULL POINTER DEREFERENCE
// ============================================

struct OptionalInt
    has_value: bool,
    value: int
end

func Some(value: int) -> OptionalInt
    return OptionalInt(true, value)
end

func None() -> OptionalInt
    return OptionalInt(false, 0)
end

func safe_dereference(opt: OptionalInt) -> Result
    if !opt.has_value then
        return Err(ERROR_NULL_DEREFERENCE)
    end
    // Simplesmente extrai o valor de forma segura
    // Em linguagens tradicionais, acessar null crasharia aqui
    return Ok(opt.value)
end

print("ðŸ”¥ ERRO #3: NULL POINTER DEREFERENCE")
print("Problema: Acessar valor null quebra o programa")
print("SoluÃ§Ã£o: VerificaÃ§Ã£o explÃ­cita antes do uso")
print("")

let valid_value: OptionalInt = Some(42)
let null_value: OptionalInt = None()

let deref_ok: Result = safe_dereference(valid_value)
let deref_fail: Result = safe_dereference(null_value)

print_result("deref(Some(42))", deref_ok)
print_result("deref(None)", deref_fail)

if is_ok(deref_ok) then
    print("â†’ Valor extraÃ­do com seguranÃ§a: " + to_str(deref_ok.value))
    
    // Agora posso usar o valor em operaÃ§Ãµes, como divisÃ£o
    let division_result: Result = safe_divide(100, deref_ok.value)
    print_result("100 Ã· " + to_str(deref_ok.value), division_result)
end

if is_err(deref_fail) then
    print("â†’ Null detectado! Em C/C++ isso seria um crash")
    // Demonstra o que aconteceria se tentÃ¡ssemos usar o valor null
    print("â†’ Tentativa de divisÃ£o com valor null evitada!")
end

print("")

// ============================================
// ERRO #4: PARSE/CONVERSION FAILURE
// ============================================

func safe_parse_positive(value: int) -> Result
    if value < 0 then
        return Err(ERROR_PARSE_FAILURE)
    end
    return Ok(value)
end

print("ðŸ”¥ ERRO #4: PARSE/CONVERSION FAILURE")
print("Problema: ConversÃ£o invÃ¡lida causa comportamento indefinido")
print("SoluÃ§Ã£o: ValidaÃ§Ã£o explÃ­cita com Result")
print("")

let parse_ok: Result = safe_parse_positive(123)
let parse_fail: Result = safe_parse_positive(-456)

print_result("parse(123)", parse_ok)
print_result("parse(-456)", parse_fail)

if is_ok(parse_ok) then
    print("â†’ Valor vÃ¡lido: " + to_str(parse_ok.value))
end

if is_err(parse_fail) then
    print("â†’ Entrada invÃ¡lida, usando padrÃ£o: " + to_str(unwrap_or(parse_fail, 0)))
end

print("")

// ============================================
// RESUMO: ANTES vs DEPOIS
// ============================================

print("=== RESUMO: TRANSFORMAÃ‡ÃƒO COMPLETA ===")
print("")
print("âŒ ANTES (cÃ³digo perigoso):")
print("   â€¢ DivisÃµes quebram o programa")
print("   â€¢ Arrays causam buffer overflow")
print("   â€¢ Null pointers causam crashes")
print("   â€¢ Parse falha silenciosamente")
print("")
print("âœ… DEPOIS (cÃ³digo seguro):")
print("   â€¢ Erros sÃ£o valores explÃ­citos")
print("   â€¢ Falhas sÃ£o tratadas graciosamente")
print("   â€¢ Bugs sÃ£o impossÃ­veis por design")
print("   â€¢ CÃ³digo Ã© autodocumentado")
print("")
print("ðŸŽ¯ RESULTADO: ZERO CRASHES, 100% CONFIÃVEL!")
print("")
print("ðŸ¦€ Inspirado por Rust - Zero-cost abstractions para seguranÃ§a mÃ¡xima")
